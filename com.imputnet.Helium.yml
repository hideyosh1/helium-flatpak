app-id: com.imputnet.Helium
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
command: helium

x-annotations:
  org.flatpak.metadata.name: "Helium"
  org.flatpak.metadata.summary: "Private, fast, and honest web browser"
  org.flatpak.metadata.description: |
    Helium is a lightweight, privacy-focused browser built upon Ungoogled Chromium.
    This Flatpak package uses the prebuilt binary provided by the Helium Linux project.
  org.flatpak.metadata.license: "GPL-3.0-or-later"
  org.flatpak.metadata.homepage: "https://github.com/imputnet/helium-linux"

finish-args:
  - --share=network
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=cups # allow printing
  - --socket=pcsc
  - --device=dri
  - --device=all
  - --socket=pulseaudio
  - --allow=bluetooth
  # D-bus names to allow inhibiting sleep, enable media controls, and other stuff
  # Based on com.Google.Chrome flatpak
  - --system-talk-name=org.bluez
  - --system-talk-name=org.freedesktop.UPower
  - --talk-name=org.freedesktop.FileManager1
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.gnome.SessionManager
  - --talk-name=org.kde.StatusNotifierWatcher
  - --system-talk-name=org.freedesktop.Avahi
  - --own-name=org.mpris.MediaPlayer2.chromium.*
  - --filesystem=xdg-download
  - --filesystem=xdg-pictures
  - --filesystem=xdg-videos
  - --filesystem=xdg-desktop
  - --persist=.pki
  - --env=LD_LIBRARY_PATH=/app/lib/helium:$LD_LIBRARY_PATH
  - --env=CHROME_DEVEL_SANDBOX_DISABLED=1
  - --env=ICU_DATA_PATH=/app/lib/helium
  # Allow PWAs
  - --filesystem=home/.local/share/applications:create
  - --filesystem=home/.local/share/icons:create
  # GNOME-specific
  - --filesystem=xdg-run/dconf
  - --filesystem=~/.config/dconf:ro
  - --talk-name=ca.desrt.dconf
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf
  - --env=GIO_EXTRA_MODULES=/app/lib/gio/modules
  - --env=GSETTINGS_BACKEND=dconf
  # KDE-specific
  - --filesystem=~/.config/kioslaverc

modules:
  - name: helium
    metadata: com.imputnet.Helium.metainfo.xml
    buildsystem: simple
    build-commands:
      - tar -xvf helium-linux-x64.tar.gz
      - mkdir -p /app/lib/helium
      - mkdir -p /app/bin
      - cp -r helium-0.9.1.1-x86_64_linux/* /app/lib/helium
      - install -Dm755 helium-0.9.1.1-x86_64_linux/helium /app/lib/helium/helium.real

      - echo '#!/bin/sh' > /app/bin/helium
      - echo 'exec /app/lib/helium/helium.real --no-sandbox --test-type "$@"' >> /app/bin/helium
      - chmod +x /app/bin/helium

      - install -Dm644 com.imputnet.Helium.desktop /app/share/applications/com.imputnet.Helium.desktop

      - mkdir -p icons/512x512 icons/256x256 icons/128x128 icons/64x64 icons/32x32
      - cp com.imputnet.Helium.png icons/512x512/
      - cp com.imputnet.Helium.png icons/256x256/
      - cp com.imputnet.Helium.png icons/128x128/
      - cp com.imputnet.Helium.png icons/64x64/
      - cp com.imputnet.Helium.png icons/32x32/

      - install -Dm644 icons/512x512/com.imputnet.Helium.png /app/share/icons/hicolor/512x512/apps/com.imputnet.Helium.png  
      - install -Dm644 icons/256x256/com.imputnet.Helium.png /app/share/icons/hicolor/256x256/apps/com.imputnet.Helium.png
      - install -Dm644 icons/128x128/com.imputnet.Helium.png /app/share/icons/hicolor/128x128/apps/com.imputnet.Helium.png
      - install -Dm644 icons/64x64/com.imputnet.Helium.png /app/share/icons/hicolor/64x64/apps/com.imputnet.Helium.png
      - install -Dm644 icons/32x32/com.imputnet.Helium.png /app/share/icons/hicolor/32x32/apps/com.imputnet.Helium.png

    sources:
      - type: file
        url: https://github.com/imputnet/helium-linux/releases/download/0.9.1.1/helium-0.9.1.1-x86_64_linux.tar.xz
        sha256: 07ed9034bdf61d628f9dcdac5e2abc9f3d13cf64d865a0601a30c54aabb79c3a
        dest-filename: helium-linux-x64.tar.gz
      - type: file
        path: com.imputnet.Helium.metainfo.xml
      - type: file
        path: com.imputnet.Helium.desktop

      - type: file
        path: icons/32x32/com.imputnet.Helium.png
      - type: file
        path: icons/64x64/com.imputnet.Helium.png
      - type: file
        path: icons/128x128/com.imputnet.Helium.png
      - type: file
        path: icons/256x256/com.imputnet.Helium.png
      - type: file
        path: icons/512x512/com.imputnet.Helium.png
